name: space-weather

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      HTTP_USER_AGENT: "(gaiaeyes.com, gaiaeyes7.83@gmail.com)"
      SINCE_HOURS: "72"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify required envs
        run: |
          if [ -z "${SUPABASE_DB_URL}" ]; then
            echo "❌ SUPABASE_DB_URL is not set. Check repo Settings → Secrets and variables → Actions."
            exit 1
          fi
          python - <<'PY'
import os, re
u = os.environ.get("SUPABASE_DB_URL")
print("✅ SUPABASE_DB_URL present. Length:", len(u))
print("   Scheme:", u.split(":",1)[0] if u else "missing")
print("   Has '@' host section:", "@" in u)
print("   Looks like pooler:", "pooler.supabase.com" in u)
PY

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install httpx asyncpg

      - name: Run ingester
        run: python backend/scripts/ingest_space_weather_custom.py
