name: Gaia Eyes — Daily Pipeline
permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "5 14 * * *" # 14:05 UTC ~ 09:05 America/Chicago
  workflow_dispatch:
    inputs:
      date:
        description: "YYYY-MM-DD (optional; defaults to GAIA_TIMEZONE today)"
        required: false
      platform:
        description: "daily_posts.platform"
        required: false
        default: "default"

jobs:
  generate:
    name: Generate Earthscope → Supabase
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EARTHSCOPE_DEBUG_REWRITE: "true"
      SUPABASE_POSTS_SCHEMA: content
      SUPABASE_POSTS_TABLE: daily_posts
      SUPABASE_MARTS_SCHEMA: marts
      SUPABASE_SW_TABLE: space_weather_daily
      SUPABASE_SR_TABLE: schumann_daily
      SUPABASE_DAY_COLUMN: day
      EARTHSCOPE_PLATFORM: ${{ github.event.inputs.platform || 'default' }}
      # Media repo for JSON emit + unified inputs
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      MEDIA_REPO_TOKEN: ${{ secrets.GAIAEYES_MEDIA_TOKEN }}
      MEDIA_REPO_PATH:  ${{ github.workspace }}/gaiaeyes-media

      # Earthscope generator toggles
      EARTHSCOPE_USE_MEDIA: "true"
      EARTHSCOPE_MEDIA_DIR: ${{ github.workspace }}/gaiaeyes-media
      EARTHSCOPE_HYBRID_REWRITE: "true"
      EARTHSCOPE_FORCE_RULES: "false"
      AURORA_REGION: "mid"
      EARTHSCOPE_OUTPUT_JSON_PATH: ${{ github.workspace }}/gaiaeyes-media/data/earthscope_daily.json
      EARTHSCOPE_PULSE_JSON: ${{ github.workspace }}/gaiaeyes-media/data/pulse.json
    steps:
      - uses: actions/checkout@v4
      - name: Clone media repo (for JSON emit)
        run: |
          set -euo pipefail
          if [ -d "${MEDIA_REPO_PATH}/.git" ]; then
            git -C "${MEDIA_REPO_PATH}" remote set-url origin "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git"
            git -C "${MEDIA_REPO_PATH}" fetch --prune --depth=1 origin
            git -C "${MEDIA_REPO_PATH}" checkout -B main
            git -C "${MEDIA_REPO_PATH}" reset --hard origin/main
            git -C "${MEDIA_REPO_PATH}" clean -fdx
          else
            rm -rf "${MEDIA_REPO_PATH}" || true
            git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
          fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install openai supabase
      - name: Run generator (earthscope_generate.py)
        working-directory: bots/earthscope_post
        run: |
          DATE_ARG=""
          if [ -n "${{ github.event.inputs.date }}" ]; then DATE_ARG="--date ${{ github.event.inputs.date }}"; fi
          python earthscope_generate.py $DATE_ARG --platform ${{ env.EARTHSCOPE_PLATFORM }}
      - name: Commit & push earthscope_daily.json
        if: always()
        run: |
          set -euo pipefail
          cd "${MEDIA_REPO_PATH}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config pull.rebase true
          # Stage JSON if present
          if [ -f "data/earthscope_daily.json" ]; then
            git add data/earthscope_daily.json
          fi
          # Commit only if there are changes
          if git diff --cached --quiet; then
            echo "No earthscope_daily.json changes to commit."
            exit 0
          fi
          ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git commit -m "earthscope daily card ${ts} [skip ci]"
          git fetch origin main || true
          git pull --rebase origin main || true
          for attempt in 1 2 3; do
            if git push origin HEAD:main; then
              echo "Push succeeded on attempt ${attempt}."
              exit 0
            fi
            echo "Push failed on attempt ${attempt}; rebasing and retrying…"
            git fetch origin main || true
            git pull --rebase origin main || true
            sleep $((RANDOM % 4 + 2))
          done
          echo "ERROR: Could not push after 3 attempts."
          exit 1

  render:
    name: Render Images → Media Repo
    runs-on: ubuntu-latest
    needs: generate
    permissions:
      contents: write
      issues: write
    outputs:
      media_sha: ${{ steps.media_sha.outputs.sha }}
      supabase_media_base: ${{ steps.supabase_base.outputs.base }}
    env:
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_USER_ID: ${{ secrets.EARTHSCOPE_USER_ID }}
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      MEDIA_REPO_TOKEN: ${{ secrets.GAIAEYES_MEDIA_TOKEN }}
      MEDIA_REPO_PATH:  ${{ github.workspace }}/gaiaeyes-media
      LOGO_PATH:        ${{ github.workspace }}/bots/earthscope_post/GaiaEyesLogo.png
      EARTHSCOPE_USE_MEDIA: "true"
      EARTHSCOPE_MEDIA_DIR: ${{ github.workspace }}/gaiaeyes-media
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_MEDIA_BASE: ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/space-visuals/social/earthscope/latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone media repo
        run: |
          set -euo pipefail
          if [ -d "${MEDIA_REPO_PATH}" ]; then
            echo "MEDIA_REPO_PATH exists: ${MEDIA_REPO_PATH}"
            if [ -d "${MEDIA_REPO_PATH}/.git" ]; then
              echo "Existing git repo detected — syncing with remote."
              git -C "${MEDIA_REPO_PATH}" remote set-url origin "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git"
              git -C "${MEDIA_REPO_PATH}" fetch --prune --depth=1 origin
              # default branch assumed 'main'; adjust if your media repo uses a different default
              git -C "${MEDIA_REPO_PATH}" checkout -B main
              git -C "${MEDIA_REPO_PATH}" reset --hard origin/main
              git -C "${MEDIA_REPO_PATH}" clean -fdx
            else
              echo "Existing non-git directory — removing and recloning."
              rm -rf "${MEDIA_REPO_PATH}"
              git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
            fi
          else
            echo "Cloning fresh media repo into ${MEDIA_REPO_PATH}"
            git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
          fi
      - name: Configure git identity (media repo)
        run: |
          git -C "${MEDIA_REPO_PATH}" config user.name  "github-actions[bot]"
          git -C "${MEDIA_REPO_PATH}" config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Render cards (bot commits & pushes)
        working-directory: bots/earthscope_post
        env:
          MEDIA_REPO_PATH: ${{ env.MEDIA_REPO_PATH }}
          LOGO_PATH: ${{ env.LOGO_PATH }}
        run: |
          python gaia_eyes_viral_bot.py
      - name: Upload rendered images to Supabase Storage (social/earthscope/latest)
        run: |
          set -euo pipefail
          shopt -s nullglob
          IMG_DIR="${MEDIA_REPO_PATH}/images"
          if [ ! -d "$IMG_DIR" ]; then
            echo "No images directory at ${IMG_DIR}; nothing to upload."
            exit 0
          fi
          echo "Uploading images from ${IMG_DIR} to ${SUPABASE_MEDIA_BASE}"
          up_count=0
          fail_count=0
          for f in "${IMG_DIR}"/*.jpg "${IMG_DIR}"/*.jpeg "${IMG_DIR}"/*.png; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            ext="${name##*.}"
            ct="image/jpeg"
            if [ "${ext,,}" = "png" ]; then ct="image/png"; fi
            url="${SUPABASE_URL}/storage/v1/object/space-visuals/social/earthscope/latest/${name}"
            code=$(curl -sS -o /dev/null -w "%{http_code}" -X POST \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "x-upsert: true" \
              -H "Content-Type: ${ct}" \
              --data-binary @"${f}" \
              "${url}")
            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
              printf "[upload] %-28s -> %s/%s\n" "$name" "${SUPABASE_MEDIA_BASE}" "$name"
              up_count=$((up_count+1))
            else
              echo "[upload] FAILED ($code) for ${name}"
              fail_count=$((fail_count+1))
            fi
          done
          echo "[upload] done ok=${up_count} fail=${fail_count}"
      - name: Set Supabase media base output
        id: supabase_base
        run: echo "base=${SUPABASE_MEDIA_BASE}" >> "$GITHUB_OUTPUT"
      - name: Get media repo commit sha
        id: media_sha
        run: |
          cd "${MEDIA_REPO_PATH}"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  post:
    name: Post Square + Carousel
    runs-on: ubuntu-latest
    needs: render
    permissions:
      contents: write
      issues: write
    env:
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
      IG_USER_ID: ${{ secrets.IG_USER_ID }}
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      MEDIA_CDN_BASE:   ${{ needs.render.outputs.supabase_media_base }}
    steps:
      - uses: actions/checkout@v4
      - name: Wait for CDN propagation
        run: sleep 60
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests python-dotenv
      - name: Post square (FB)
        working-directory: bots/earthscope_post
        run: python meta_poster.py post-square
      - name: Post carousel (FB)
        working-directory: bots/earthscope_post
        run: |
          set -e
          # Try the unified subcommand first; fall back if repo still uses legacy name
          if python meta_poster.py post-carousel --platform fb; then
            echo "Facebook carousel posted via --platform fb."
          else
            echo "Falling back to legacy 'post-carousel-fb' subcommand…"
            python meta_poster.py post-carousel-fb
          fi
      - name: Post carousel (IG)
        working-directory: bots/earthscope_post
        run: |
          set -e
          # Try the unified subcommand first; fall back if repo still uses legacy name
          if python meta_poster.py post-carousel --platform ig; then
            echo "Instagram carousel posted via --platform ig."
          else
            echo "Falling back to legacy 'post-carousel-ig' subcommand…"
            python meta_poster.py post-carousel-ig
          fi
