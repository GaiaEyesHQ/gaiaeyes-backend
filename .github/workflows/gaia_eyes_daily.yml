name: Gaia Eyes — Daily Pipeline
permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "5 14 * * *" # 14:05 UTC ~ 09:05 America/Chicago
  workflow_dispatch:
    inputs:
      date:
        description: "YYYY-MM-DD (optional; defaults to GAIA_TIMEZONE today)"
        required: false
      platform:
        description: "daily_posts.platform"
        required: false
        default: "default"

jobs:
  generate:
    name: Generate Earthscope → Supabase
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EARTHSCOPE_DEBUG_REWRITE: "true"
      SUPABASE_POSTS_SCHEMA: content
      SUPABASE_POSTS_TABLE: daily_posts
      SUPABASE_MARTS_SCHEMA: marts
      SUPABASE_SW_TABLE: space_weather_daily
      SUPABASE_SR_TABLE: schumann_daily
      SUPABASE_DAY_COLUMN: day
      EARTHSCOPE_PLATFORM: ${{ github.event.inputs.platform || 'default' }}
      # Media repo for JSON emit + unified inputs
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      MEDIA_REPO_TOKEN: ${{ secrets.GAIAEYES_MEDIA_TOKEN }}
      MEDIA_REPO_PATH:  ${{ github.workspace }}/gaiaeyes-media

      # Earthscope generator toggles
      EARTHSCOPE_USE_MEDIA: "true"
      EARTHSCOPE_MEDIA_DIR: ${{ github.workspace }}/gaiaeyes-media
      EARTHSCOPE_HYBRID_REWRITE: "true"
      EARTHSCOPE_FORCE_RULES: "false"
      AURORA_REGION: "mid"
      EARTHSCOPE_OUTPUT_JSON_PATH: ${{ github.workspace }}/gaiaeyes-media/data/earthscope_daily.json
      EARTHSCOPE_PULSE_JSON: ${{ github.workspace }}/gaiaeyes-media/data/pulse.json
    steps:
      - uses: actions/checkout@v4
      - name: Clone media repo (for JSON emit)
        run: |
          set -euo pipefail
          if [ -d "${MEDIA_REPO_PATH}/.git" ]; then
            git -C "${MEDIA_REPO_PATH}" remote set-url origin "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git"
            git -C "${MEDIA_REPO_PATH}" fetch --prune --depth=1 origin
            git -C "${MEDIA_REPO_PATH}" checkout -B main
            git -C "${MEDIA_REPO_PATH}" reset --hard origin/main
            git -C "${MEDIA_REPO_PATH}" clean -fdx
          else
            rm -rf "${MEDIA_REPO_PATH}" || true
            git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
          fi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install openai supabase
      - name: Run generator (earthscope_generate.py)
        working-directory: bots/earthscope_post
        run: |
          DATE_ARG=""
          if [ -n "${{ github.event.inputs.date }}" ]; then DATE_ARG="--date ${{ github.event.inputs.date }}"; fi
          python earthscope_generate.py $DATE_ARG --platform ${{ env.EARTHSCOPE_PLATFORM }}
      - name: Commit & push earthscope_daily.json
        if: always()
        run: |
          set -euo pipefail
          cd "${MEDIA_REPO_PATH}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config pull.rebase true
          # Stage JSON if present
          if [ -f "data/earthscope_daily.json" ]; then
            git add data/earthscope_daily.json
          fi
          # Commit only if there are changes
          if git diff --cached --quiet; then
            echo "No earthscope_daily.json changes to commit."
            exit 0
          fi
          ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git commit -m "earthscope daily card ${ts} [skip ci]"
          git fetch origin main || true
          git pull --rebase origin main || true
          for attempt in 1 2 3; do
            if git push origin HEAD:main; then
              echo "Push succeeded on attempt ${attempt}."
              exit 0
            fi
            echo "Push failed on attempt ${attempt}; rebasing and retrying…"
            git fetch origin main || true
            git pull --rebase origin main || true
            sleep $((RANDOM % 4 + 2))
          done
          echo "ERROR: Could not push after 3 attempts."
          exit 1

  render:
    name: Render Images → Media Repo
    runs-on: ubuntu-latest
    needs: generate
    permissions:
      contents: write
      issues: write
    outputs:
      media_sha: ${{ steps.media_sha.outputs.sha }}
    env:
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_USER_ID: ${{ secrets.EARTHSCOPE_USER_ID }}
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      MEDIA_REPO_TOKEN: ${{ secrets.GAIAEYES_MEDIA_TOKEN }}
      MEDIA_REPO_PATH:  ${{ github.workspace }}/gaiaeyes-media
      LOGO_PATH:        ${{ github.workspace }}/bots/earthscope_post/GaiaEyesLogo.png
      EARTHSCOPE_USE_MEDIA: "true"
      EARTHSCOPE_MEDIA_DIR: ${{ github.workspace }}/gaiaeyes-media
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_MEDIA_BASE: ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/space-visuals/social/earthscope/latest
    steps:
      - uses: actions/checkout@v4
      - name: Clone media repo
        run: |
          set -euo pipefail
          if [ -d "${MEDIA_REPO_PATH}" ]; then
            echo "MEDIA_REPO_PATH exists: ${MEDIA_REPO_PATH}"
            if [ -d "${MEDIA_REPO_PATH}/.git" ]; then
              echo "Existing git repo detected — syncing with remote."
              git -C "${MEDIA_REPO_PATH}" remote set-url origin "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git"
              git -C "${MEDIA_REPO_PATH}" fetch --prune --depth=1 origin
              # default branch assumed 'main'; adjust if your media repo uses a different default
              git -C "${MEDIA_REPO_PATH}" checkout -B main
              git -C "${MEDIA_REPO_PATH}" reset --hard origin/main
              git -C "${MEDIA_REPO_PATH}" clean -fdx
            else
              echo "Existing non-git directory — removing and recloning."
              rm -rf "${MEDIA_REPO_PATH}"
              git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
            fi
          else
            echo "Cloning fresh media repo into ${MEDIA_REPO_PATH}"
            git clone --depth 1 "https://x-access-token:${MEDIA_REPO_TOKEN}@github.com/${MEDIA_REPO_OWNER}/${MEDIA_REPO_NAME}.git" "${MEDIA_REPO_PATH}"
          fi
      - name: Configure git identity (media repo)
        run: |
          git -C "${MEDIA_REPO_PATH}" config user.name  "github-actions[bot]"
          git -C "${MEDIA_REPO_PATH}" config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Render cards (bot commits & pushes)
        working-directory: bots/earthscope_post
        env:
          MEDIA_REPO_PATH: ${{ env.MEDIA_REPO_PATH }}
          LOGO_PATH: ${{ env.LOGO_PATH }}
        run: |
          python gaia_eyes_viral_bot.py
      - name: Upload rendered images to Supabase Storage (social/earthscope/latest)
        run: |
          set -euo pipefail
          shopt -s nullglob

          IMG_DIR="${MEDIA_REPO_PATH}/images"
          if [ ! -d "$IMG_DIR" ]; then
            echo "No images directory at ${IMG_DIR}; nothing to upload."
            exit 0
          fi

          # Normalize and validate SUPABASE_URL (trim spaces/CRLF and trailing slash)
          SUPABASE_URL_TRIMMED="$(printf '%s' "${SUPABASE_URL:-}" | tr -d '\r' | sed -e 's/[[:space:]]\+$//' -e 's#/$##')"
          if ! printf '%s' "${SUPABASE_URL_TRIMMED}" | grep -Eq '^https?://'; then
            echo "[error] SUPABASE_URL looks invalid: '${SUPABASE_URL_TRIMMED}'"
            exit 1
          fi

          OBJECT_PATH_BASE="/storage/v1/object/space-visuals/social/earthscope/latest"

          echo "Uploading images from ${IMG_DIR} to ${SUPABASE_URL_TRIMMED}${OBJECT_PATH_BASE}"
          up_count=0
          fail_count=0

          for f in "${IMG_DIR}"/*.jpg "${IMG_DIR}"/*.jpeg "${IMG_DIR}"/*.png; do
            [ -e "$f" ] || continue
            name="$(basename "$f")"
            # Guard against problematic filenames (spaces, etc.)
            if [[ "$name" == *" "* ]]; then
              echo "[upload] Skipping '$name' (contains spaces — not a post asset)"
              continue
            fi
            # URL-encode the object name for the request URL
            name_enc=$(python -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$name")
            ext="${name##*.}"
            ct="image/jpeg"
            if [ "${ext,,}" = "png" ]; then ct="image/png"; fi
            url="${SUPABASE_URL_TRIMMED}${OBJECT_PATH_BASE}/${name_enc}"

            echo "[debug] PUT ${OBJECT_PATH_BASE}/${name}"
            code=$(curl -sS -o /dev/null -w "%{http_code}" -X PUT \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "x-upsert: true" \
              -H "Content-Type: ${ct}" \
              --data-binary @"${f}" \
              "${url}")

            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
              printf "[upload] %-28s -> %s/%s\n" "$name" "${SUPABASE_MEDIA_BASE}" "$name"
              up_count=$((up_count+1))
            else
              echo "[upload] FAILED ($code) for ${name}"
              fail_count=$((fail_count+1))
            fi
          done

          echo "[upload] done ok=${up_count} fail=${fail_count}"
          if [ "$up_count" -eq 0 ]; then
            echo "[upload] No files uploaded successfully."
            exit 1
          fi
      - name: Get media repo commit sha
        id: media_sha
        run: |
          cd "${MEDIA_REPO_PATH}"
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  post:
    name: Post Square + Carousel
    runs-on: ubuntu-latest
    needs: render
    permissions:
      contents: write
      issues: write
    env:
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      GAIA_TIMEZONE: ${{ secrets.GAIA_TIMEZONE }}
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
      IG_USER_ID: ${{ secrets.IG_USER_ID }}
      MEDIA_REPO_OWNER: ${{ secrets.MEDIA_REPO_OWNER }}
      MEDIA_REPO_NAME:  ${{ secrets.MEDIA_REPO_NAME }}
      SUPABASE_URL:     ${{ secrets.SUPABASE_URL }}
      MEDIA_CDN_BASE:   ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/space-visuals/social/earthscope/latest
    steps:
      - uses: actions/checkout@v4
      - name: Wait for CDN propagation
        run: sleep 60
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests python-dotenv
      - name: Mirror default daily_post to IG platform
        env:
          REST_URL: ${{ env.SUPABASE_REST_URL }}
          SERVICE_KEY: ${{ env.SUPABASE_SERVICE_KEY }}
        run: |
          set -euo pipefail

          echo "[mirror] REST_URL=${REST_URL}"
          # Fetch latest 'default' daily_post as JSON (force array shape)
          payload="$(curl -sS \
            -H "apikey: ${SERVICE_KEY}" \
            -H "Authorization: Bearer ${SERVICE_KEY}" \
            -H "Accept: application/json" \
            -H "Accept-Profile: content" \
            "${REST_URL}/daily_posts?select=*&platform=eq.default&order=day.desc&limit=1")"

          # Log a short preview of the payload for troubleshooting
          echo "[mirror] payload preview: $(printf '%s' "$payload" | tr -d '\n' | cut -c1-160)..."

          # Normalize to a single row:
          # - If it's an array with at least one item, take [0]
          # - If it's an object that already looks like a row (has "day"), pass it through
          # - Otherwise, treat as empty
          row="$(
            printf '%s' "$payload" | jq -c '
              if type=="array" then
                if length>0 then .[0] else empty end
              elif (type=="object" and has("day")) then
                .
              else
                empty
              end
            '
          )"

          if [ -z "${row}" ]; then
            echo "[mirror] No default daily_post to mirror; skipping."
            exit 0
          fi

          day="$(printf '%s' "$row" | jq -r '.day // empty')"
          echo "[mirror] Mirroring day=${day:-unknown} to platform=ig"

          # Rewrite platform, drop id if present
          ig_row="$(printf '%s' "$row" | jq -c '.platform="ig" | del(.id)')"

          # Upsert into content.daily_posts
          status="$(curl -sS -o /dev/null -w "%{http_code}" -X POST "${REST_URL}/daily_posts?on_conflict=day,platform" \
            -H "apikey: ${SERVICE_KEY}" \
            -H "Authorization: Bearer ${SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Content-Profile: content" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[$ig_row]")"

          if [ "$status" != "200" ] && [ "$status" != "201" ]; then
            echo "[mirror] Upsert failed with HTTP ${status}"
            exit 1
          fi
          echo "[mirror] Upsert OK for IG daily_post (day=${day:-unknown})"
      - name: Post square (FB) — disabled
        if: ${{ false }}  # temporarily disable square posts (both FB and IG via meta_poster)
        working-directory: bots/earthscope_post
        run: python meta_poster.py post-square --media-base "${{ env.MEDIA_CDN_BASE }}"
      - name: Post carousel (FB)
        working-directory: bots/earthscope_post
        run: |
          set -e
          # Try the unified subcommand first; fall back if repo still uses legacy name
          if python meta_poster.py post-carousel --platform fb --media-base "${{ env.MEDIA_CDN_BASE }}"; then
            echo "Facebook carousel posted via --platform fb."
          else
            echo "Falling back to legacy 'post-carousel-fb' subcommand…"
            python meta_poster.py post-carousel-fb --media-base "${{ env.MEDIA_CDN_BASE }}"
          fi
      - name: Post carousel (IG)
        working-directory: bots/earthscope_post
        run: |
          set -euo pipefail
          # Use unified subcommand; IG content is mirrored from 'default' above
          echo "Using media base: ${{ env.MEDIA_CDN_BASE }}"
          python meta_poster.py post-carousel --platform ig --media-base "${{ env.MEDIA_CDN_BASE }}"

  reel:
    name: Build Reel → Supabase
    runs-on: ubuntu-latest
    needs: render
    permissions:
      contents: read
      issues: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      MEDIA_CDN_BASE: ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/space-visuals/social/earthscope/latest
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      IG_USER_ID: ${{ secrets.IG_USER_ID }}
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps (reel)
        working-directory: bots/earthscope_post
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Extras commonly required by the reel builder
          pip install moviepy pydub soundfile numpy pillow requests openai
          pip install supabase

      - name: Stage reel images from Supabase (latest)
        run: |
          set -euo pipefail
          BASE="${MEDIA_CDN_BASE}"
          OUT_DIR="${GITHUB_WORKSPACE}/reel_media/images"
          mkdir -p "${OUT_DIR}"

          fetch() {
            local name="$1"
            local url="${BASE}/${name}"
            echo "[fetch] ${url}"
            if curl -fSsL "${url}" -o "${OUT_DIR}/${name}"; then
              echo "[ok] ${name}"
            else
              echo "[miss] ${name}"
            fi
          }

          # Try the canonical cards (optional if some are missing)
          fetch dailypost.jpg
          fetch daily_stats.jpg
          fetch daily_affects.jpg
          fetch daily_playbook.jpg
          fetch daily_caption.jpg

          shopt -s nullglob
          files=("${OUT_DIR}"/*.jpg "${OUT_DIR}"/*.png)
          if [ ${#files[@]} -eq 0 ]; then
            echo "[error] No cards available under ${OUT_DIR}"
            exit 1
          fi

      - name: Build reel (reel_builder.py)
        working-directory: bots/earthscope_post
        env:
          REEL_MEDIA_BASE: ${{ env.MEDIA_CDN_BASE }}
          REEL_VO_TAIL_PAD_SEC: "2.5"
          REEL_BED_URL: ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/space-visuals/social/earthscope/music/bed01.wav
          REEL_OUT: ${{ github.workspace }}/reel.mp4
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MEDIA_REPO_PATH: ${{ github.workspace }}/reel_media
        run: |
          set -euo pipefail
          echo "Building reel — using staged images at ${GITHUB_WORKSPACE}/reel_media/images"
          python reel_builder.py \
            --bed-url "${REEL_BED_URL}" \
            --out "${REEL_OUT}"
          test -s "${REEL_OUT}"

      - name: Upload reel to Supabase Storage (reels/latest)
        run: |
          set -euo pipefail
          SUPABASE_URL_TRIMMED="$(printf '%s' "${SUPABASE_URL:-}" | tr -d '\r' | sed -e 's/[[:space:]]\+$//' -e 's#/$##')"
          OBJECT_BASE="/storage/v1/object/space-visuals/social/earthscope/reels/latest"
          ts="$(date -u +'%Y%m%dT%H%M%SZ')"
          day="$(date -u +%F)"
          name="reel_${day:-${ts}}.mp4"
          url="${SUPABASE_URL_TRIMMED}${OBJECT_BASE}/${name}"

          echo "[upload] PUT ${url}"
          code=$(curl -sS -o /dev/null -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "x-upsert: true" \
            -H "Content-Type: video/mp4" \
            --data-binary @"${{ github.workspace }}/reel.mp4" \
            "${url}")
          echo "[upload] ${name} -> HTTP ${code}"

          # also update latest.mp4 pointer for easy embedding
          url_latest="${SUPABASE_URL_TRIMMED}${OBJECT_BASE}/latest.mp4"
          code_latest=$(curl -sS -o /dev/null -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "x-upsert: true" \
            -H "Content-Type: video/mp4" \
            --data-binary @"${{ github.workspace }}/reel.mp4" \
            "${url_latest}")
          echo "[upload] latest.mp4 -> HTTP ${code_latest}"

      - name: Wait for CDN (reel)
        run: sleep 30

      - name: Compose reel URL & caption
        env:
          REST_URL: ${{ env.SUPABASE_REST_URL }}
          SERVICE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          # Public URL of the just-uploaded reel
          REEL_URL="${SUPABASE_URL}/storage/v1/object/public/space-visuals/social/earthscope/reels/latest/latest.mp4"
          echo "REEL_URL=${REEL_URL}"
          echo "REEL_URL=${REEL_URL}" >> "$GITHUB_ENV"

          # Helper to fetch latest post row for a platform
          fetch_cap() {
            local plat="$1"
            curl -sS \
              -H "apikey: ${SERVICE_KEY}" \
              -H "Authorization: Bearer ${SERVICE_KEY}" \
              -H "Accept: application/json" \
              -H "Accept-Profile: content" \
              "${REST_URL}/daily_posts?select=*&platform=eq.${plat}&order=day.desc&limit=1"
          }

          # Prefer IG-specific post; fall back to default
          cap_json="$(fetch_cap ig || true)"
          if [ -z "${cap_json}" ] || [ "$(printf '%s' "$cap_json" | jq 'type=="array" and length or 0')" = "false" ]; then
            cap_json="$(fetch_cap default || true)"
          fi

          # Extract a reasonable caption; clamp to 2200 chars for IG
          caption="$(
            printf '%s' "$cap_json" | jq -r '
              (if type=="array" and length>0 then .[0] else . end)
              | (.caption // .social_caption // .short_overview // .summary // "")
            ' 2>/dev/null || true
          )"
          caption="$(printf '%s' "$caption" | head -c 2200)"
          printf '%s' "$caption" > caption.txt
          echo "Caption preview: $(printf '%s' "$caption" | tr -d '\n' | cut -c1-160)..."

      - name: Post Reel to Instagram (Graph API)
        run: |
          set -euo pipefail
          if [ -z "${IG_USER_ID:-}" ] || [ -z "${FB_ACCESS_TOKEN:-}" ]; then
            echo "Missing IG_USER_ID or FB_ACCESS_TOKEN; skipping IG reel post."
            exit 0
          fi

          # Create media container for the reel
          create_resp="$(
            curl -sS -X POST "https://graph.facebook.com/v20.0/${IG_USER_ID}/media" \
              -F "media_type=REELS" \
              -F "video_url=${REEL_URL}" \
              -F "caption=$(cat caption.txt)" \
              -F "access_token=${FB_ACCESS_TOKEN}"
          )"
          echo "IG create_resp: ${create_resp}"
          creation_id="$(printf '%s' "$create_resp" | jq -r '.id // empty')"
          if [ -z "$creation_id" ]; then
            echo "No IG creation_id; cannot continue.";
            exit 1
          fi

          # Poll container status until FINISHED (or bail on ERROR)
          status=""
          for attempt in $(seq 1 20); do
            status_resp="$(curl -sS "https://graph.facebook.com/v20.0/${creation_id}?fields=status_code&access_token=${FB_ACCESS_TOKEN}")"
            status="$(printf '%s' "$status_resp" | jq -r '.status_code // empty')"
            echo "IG status attempt ${attempt}: ${status_resp}"

            if [ "$status" = "FINISHED" ]; then
              break
            fi
            if [ "$status" = "ERROR" ]; then
              echo "IG container error state; aborting publish.";
              exit 1
            fi
            sleep 10
          done

          if [ "$status" != "FINISHED" ]; then
            echo "IG container not ready after waiting; skipping publish for now.";
            exit 0
          fi

          # Publish once ready
          publish_resp="$(
            curl -sS -X POST "https://graph.facebook.com/v20.0/${IG_USER_ID}/media_publish" \
              -F "creation_id=${creation_id}" \
              -F "access_token=${FB_ACCESS_TOKEN}"
          )"
          echo "IG publish_resp: ${publish_resp}"

      - name: Post Reel to Facebook Page (Graph API)
        run: |
          set -euo pipefail
          if [ -z "${FB_PAGE_ID:-}" ] || [ -z "${FB_ACCESS_TOKEN:-}" ]; then
            echo "Missing FB_PAGE_ID or FB_ACCESS_TOKEN; skipping FB video post."
            exit 0
          fi
          fb_resp="$(
            curl -sS -X POST "https://graph.facebook.com/v20.0/${FB_PAGE_ID}/videos" \
              -F "file_url=${REEL_URL}" \
              -F "description=$(cat caption.txt)" \
              -F "access_token=${FB_ACCESS_TOKEN}"
          )"
          echo "FB video resp: ${fb_resp}"