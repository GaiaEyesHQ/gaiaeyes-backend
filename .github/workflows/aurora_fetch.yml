name: Aurora Fetch (Staging)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"   # run every 15 minutes (adjust as you like)

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      AURORA_BASE: https://staging2.gaiaeyes.com
      # Optional: fill these if you want the workflow to also verify that rows landed in Supabase
      SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Create out dir
        run: mkdir -p out

      - name: Trigger both collectors (nowcast + viewline)
        run: |
          set -euo pipefail
          mkdir -p out
          try_post() {
            local url="$1"; local name="$2"
            echo "POST $url"
            local code
            code=$(curl -sS -o "out/${name}.json" -w "%{http_code}" -X POST "$url" -H "Accept: application/json" || true)
            echo "$name HTTP: $code"
            echo -n "$code" > "out/${name}.code"
            echo "--- $name preview ---"; head -c 200 "out/${name}.json" || true; echo
          }
          # Try known endpoints; do not fail if missing
          try_post "$AURORA_BASE/wp-json/gaia/v1/aurora/cron-run"    "cron_run"
          if [ "$(cat out/cron_run.code 2>/dev/null || echo 000)" != "200" ]; then
            try_post "$AURORA_BASE/wp-json/gaia/v1/aurora/cron_run"  "cron_run_alt"
          fi
          if [ "$(cat out/cron_run.code 2>/dev/null || echo 000)" != "200" ] && \
             [ "$(cat out/cron_run_alt.code 2>/dev/null || echo 000)" != "200" ]; then
            echo "[warn] cron endpoint not found (non-fatal). Proceeding…"
          fi

      - name: Pull diagnostics
        run: |
          set -euo pipefail
          curl -fsSL "$AURORA_BASE/wp-json/gaia/v1/aurora/diagnostics" \
            -H "Accept: application/json" \
            -o out/diagnostics.json
          jq . out/diagnostics.json || true

      - name: Pull nowcast (north & south)
        run: |
          set -euo pipefail
          mkdir -p out

          fetch_nowcast() {
            local hemi="$1" out_json="$2" out_code="$3"
            local url="$AURORA_BASE/wp-json/gaia/v1/aurora/nowcast?hemi=$hemi"
            local i=0 code=000
            : > "$out_json"
            while [ $i -lt 3 ]; do
              code=$(curl -sS -o "$out_json" -w "%{http_code}" "$url" -H "Accept: application/json" || true)
              # Accept any 2xx; if body is empty or invalid JSON, retry
              if [ "${code:0:1}" = "2" ]; then
                if [ -s "$out_json" ] && jq . "$out_json" >/dev/null 2>&1; then
                  break
                fi
              fi
              i=$((i+1))
              sleep 2
            done
            echo -n "$code" > "$out_code"
            echo "$hemi HTTP: $code"
            echo "--- $hemi preview ---"; head -c 200 "$out_json" || true; echo
          }

          echo "Fetching nowcast with retries..."
          fetch_nowcast "north" out/nowcast_north.json out/http_north.txt
          fetch_nowcast "south" out/nowcast_south.json out/http_south.txt

      - name: Basic assertions (fail if no TS)
        run: |
          set -euo pipefail
          N_CODE=$(cat out/http_north.txt 2>/dev/null || echo 000)
          S_CODE=$(cat out/http_south.txt 2>/dev/null || echo 000)
          if [ "${N_CODE:0:1}" != "2" ]; then
            echo "[fail] north nowcast HTTP=$N_CODE"; exit 1; fi
          if [ "${S_CODE:0:1}" != "2" ]; then
            echo "[fail] south nowcast HTTP=$S_CODE"; exit 1; fi
          if ! jq . out/nowcast_north.json >/dev/null 2>&1; then
            echo "[fail] north nowcast is not valid JSON"; exit 1; fi
          if ! jq . out/nowcast_south.json >/dev/null 2>&1; then
            echo "[fail] south nowcast is not valid JSON"; exit 1; fi
          if ! jq -e '(.ts // (.data.ts // .payload.ts // .result.ts)) | select(. != null) | (type=="string" or type=="number")' out/nowcast_north.json >/dev/null; then
            echo "north nowcast missing .ts — backend likely not writing cache"; exit 1; fi
          if ! jq -e '(.ts // (.data.ts // .payload.ts // .result.ts)) | select(. != null) | (type=="string" or type=="number")' out/nowcast_south.json >/dev/null; then
            echo "south nowcast missing .ts — backend likely not writing cache"; exit 1; fi

      - name: (Optional) Verify Supabase rows landed
        if: env.SUPABASE_REST_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != ''
        run: |
          set -euo pipefail
          mkdir -p out

          NOW_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          AGO6H=$(date -u -d '6 hours ago' +%Y-%m-%dT%H:%M:%SZ)
          AGO3H=$(date -u -d '3 hours ago' +%Y-%m-%dT%H:%M:%SZ)

          echo "=== Check (info) marts.aurora_nowcast_samples (last 6h) ==="
          CODE_NC=$(curl -sS -o out/supabase_nowcast_rows.json -w "%{http_code}" \
            "$SUPABASE_REST_URL/aurora_nowcast_samples?select=ts,hemisphere,kp&ts=gte.$AGO6H&order=ts.desc.nullslast&limit=6" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Accept-Profile: marts" \
            -H "Accept: application/json" || true)
          echo "nowcast HTTP: $CODE_NC"
          jq . out/supabase_nowcast_rows.json || true
          NC_COUNT=$(jq 'length' out/supabase_nowcast_rows.json 2>/dev/null || echo 0)
          if [ "${NC_COUNT}" -eq 0 ]; then
            echo "[warn] No fresh rows in marts.aurora_nowcast_samples in the last 6h (non-fatal for this job)"
          fi

          echo "=== Verify ext.aurora_power (both hemispheres, last 3h) ==="
          CODE_AP=$(curl -sS -o out/supabase_aurora_power.json -w "%{http_code}" \
            "$SUPABASE_REST_URL/aurora_power?select=ts_utc,hemisphere,hemispheric_power_gw,wing_kp&ts_utc=gte.$AGO3H&order=ts_utc.desc.nullslast&limit=10" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Accept-Profile: ext" \
            -H "Accept: application/json" || true)
          echo "aurora_power HTTP: $CODE_AP"
          jq . out/supabase_aurora_power.json || true
          HAVE_NORTH=$(jq -r '[.[] | select(.hemisphere=="north")] | length > 0' out/supabase_aurora_power.json)
          HAVE_SOUTH=$(jq -r '[.[] | select(.hemisphere=="south")] | length > 0' out/supabase_aurora_power.json)
          if [ "${HAVE_NORTH}" != "true" ] || [ "${HAVE_SOUTH}" != "true" ]; then
            echo "[fail] ext.aurora_power has no fresh rows for both hemispheres in last 3h"
            echo "       This job triggers WP to fetch; ensure the WordPress host is configured with SUPABASE_REST_URL and SUPABASE_SERVICE_ROLE_KEY env vars"
            echo "       (gaia_aurora_supabase_post in mu-plugins must have valid keys to POST to Supabase)."; exit 1;
          fi

          echo "=== (Info) marts.aurora_outlook for the next 24h ==="
          CODE_OUT=$(curl -sS -o out/supabase_aurora_outlook.json -w "%{http_code}" \
            "$SUPABASE_REST_URL/aurora_outlook?select=valid_from,valid_to,hemisphere,headline,power_gw,confidence&valid_to=gte.$NOW_UTC&order=valid_from.asc&limit=12" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Accept-Profile: marts" \
            -H "Accept: application/json" || true)
          echo "aurora_outlook HTTP: $CODE_OUT"
          jq . out/supabase_aurora_outlook.json || true

          echo "=== (Info) kp_obs latest ==="
          CODE_KP=$(curl -sS -o out/supabase_kp_rows.json -w "%{http_code}" \
            "$SUPABASE_REST_URL/kp_obs?select=kp_time,kp&order=kp_time.desc.nullslast&limit=6" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Accept-Profile: marts" \
            -H "Accept: application/json" || true)
          echo "kp_obs HTTP: $CODE_KP"
          jq . out/supabase_kp_rows.json || true

      - name: Upload artifacts (capture everything)
        uses: actions/upload-artifact@v4
        with:
          name: aurora-debug-${{ github.run_id }}
          path: out/
